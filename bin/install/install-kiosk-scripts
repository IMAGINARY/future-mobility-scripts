#!/bin/bash

if [ "$UID" -ne 0 ]
then
    >&2 echo "This script requires superuser priviledges."
    exit 1
fi

set -e

# Source config file
. "/etc/default/kiosk"

if [[ -z "${KIOSK_SCRIPTS_REPO}" ]]; then
  echo "No kiosk-script repository defined. Please set KIOSK_SCRIPTS_REPO, e.g. via kiosk-config."
  exit 1
fi

REPO="$KIOSK_SCRIPTS_REPO"

COMMITISH_DEFAULT="main"
COMMITISH="${KIOSK_SCRIPTS_COMMITISH:-$COMMITISH_DEFAULT}"
if [[ -z "${KIOSK_SCRIPTS_COMMITISH}" ]]; then
  echo "KIOSK_SCRIPTS_COMMITISH environment variable not set. Using default value: ${COMMITISH}"
else
  echo "Using KIOSK_SCRIPTS_COMMITISH environment variable. Value: ${COMMITISH}"
fi


install() {
    # don't prompt during installations
    export DEBIAN_FRONTEND=noninteractive
    
    # Install dependencies
    apt install -yq \
        augeas-tools \
        git \
        inxi \
        '' # dummy entry to terminate the list

    # retrieve files via git
    INSTALL_DIR="/opt/kiosk-scripts"
    mkdir -p "$INSTALL_DIR"
    cd "$INSTALL_DIR"
    git init

    # Checkout the requested commit or branch
    git checkout -f "$COMMITISH" 2> /dev/null || git checkout -f -b "$COMMITISH"

    if [[ `git status --porcelain` ]]; then
        git reset --hard
        echo "There were local changes. Re-running ..."
        exec "./bin/install/install-kiosk-scripts" "$@"
    else
        # no local changes, check for remote changes

        EMPTY_TREE_SHA=$(git hash-object -t tree --stdin < /dev/null)

        # When the local repo is empty, use the SHA of the empty repo, because
        # git rev-parse doesn't work in this situation
        HASH_BEFORE_UPDATE=$( ( git rev-parse "$COMMITISH" &> /dev/null && git rev-parse "$COMMITISH" ) || echo "$EMPTY_TREE_SHA" )

        "${BASH_SOURCE%/*}/../internal/install-source-from-git" "$COMMITISH" "$REPO" "/opt/kiosk-scripts"

        # When the local repo is empty, use the SHA of the empty repo, because
        # git rev-parse doesn't work in this situation
        HASH_AFTER_UPDATE=$( ( git rev-parse "$COMMITISH" &> /dev/null && git rev-parse "$COMMITISH" ) || echo "$EMPTY_TREE_SHA" )

        if [ ! "$HASH_BEFORE_UPDATE" = "$HASH_AFTER_UPDATE" ]; then
            echo "There were remote changes. Re-running ..."
            exec "./bin/install/install-kiosk-scripts" "$@"
        fi
    fi

    echo "kiosk-scripts files up to date. Running scripts ..."

    ./bin/internal/install-kiosk-scripts-local "$@"
}

install "$@"
